
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AssignMate - Student Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes slide-up {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .animate-slide-up {
          animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .animate-fade-in {
          animation: fade-in 0.2s ease-out;
        }
        .line-clamp-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;  
          overflow: hidden;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="module">
        import React from 'https://esm.sh/react@19.2.3';
        import ReactDOM from 'https://esm.sh/react-dom@19.2.3/client';
        import htm from 'https://esm.sh/htm';
        import * as Lucide from 'https://esm.sh/lucide-react@0.468.0';

        const html = htm.bind(React.createElement);
        const { useState, useEffect, useMemo, useCallback } = React;

        // Constants & Helpers
        const STORAGE_KEY = 'assignmate_data';
        const THEME_KEY = 'assignmate_theme';
        const REMINDER_OPTIONS = [
            { label: 'At due date', value: 'at_due_date' },
            { label: '1 hour before', value: '1_hour_before' },
            { label: '1 day before', value: '1_day_before' },
        ];

        // Component: Icon Helper
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const LucideIcon = Lucide[name];
            return LucideIcon ? html`<${LucideIcon} className="${className}" />` : null;
        };

        // Component: Assignment Card
        const AssignmentCard = ({ assignment, onToggleComplete, onDelete, onEdit }) => {
            const dueDate = new Date(assignment.dueDate);
            const now = new Date();
            const diffInHours = (dueDate.getTime() - now.getTime()) / (1000 * 60 * 60);
            
            let urgency = 'upcoming';
            if (dueDate < now && !assignment.isCompleted) urgency = 'overdue';
            else if (diffInHours <= 24 && diffInHours > 0 && !assignment.isCompleted) urgency = 'soon';

            const urgencyStyles = {
                overdue: 'border-red-500 bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-400',
                soon: 'border-amber-500 bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-400',
                upcoming: 'border-green-500 bg-green-50 dark:bg-green-900/10 text-green-700 dark:text-green-400',
            };

            const statusColor = assignment.isCompleted 
                ? 'border-gray-300 dark:border-gray-700 opacity-60 grayscale-[0.5]' 
                : urgencyStyles[urgency];

            return html`
                <div className="relative flex flex-col p-4 mb-4 border-l-4 rounded-r-xl bg-white dark:bg-gray-800 shadow-sm transition-all ${statusColor}">
                    <div className="flex items-start justify-between">
                        <div className="flex-1 min-w-0 pr-4">
                            <h3 className="font-bold text-lg leading-tight truncate ${assignment.isCompleted ? 'line-through text-gray-500' : 'text-gray-900 dark:text-gray-100'}">
                                ${assignment.title}
                            </h3>
                            <p className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">${assignment.subject}</p>
                        </div>
                        <button 
                            onClick=${() => onToggleComplete(assignment.id)}
                            className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                        >
                            ${assignment.isCompleted 
                                ? html`<${Icon} name="CheckCircle" className="w-6 h-6 text-green-500" />`
                                : html`<${Icon} name="Circle" className="w-6 h-6 text-gray-400" />`
                            }
                        </button>
                    </div>

                    ${assignment.notes && html`
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-2 line-clamp-2">
                            ${assignment.notes}
                        </p>
                    `}

                    <div className="mt-4 flex flex-wrap items-center gap-4 text-xs font-medium">
                        <div className="flex items-center gap-1">
                            <${Icon} name="Calendar" className="w-3.5 h-3.5" />
                            <span>${dueDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>
                        </div>
                        <div className="flex items-center gap-1">
                            <${Icon} name="Clock" className="w-3.5 h-3.5" />
                            <span>${dueDate.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        ${urgency === 'overdue' && !assignment.isCompleted && html`
                            <div className="flex items-center gap-1 text-red-600 dark:text-red-400">
                                <${Icon} name="AlertCircle" className="w-3.5 h-3.5" />
                                <span className="uppercase">Overdue</span>
                            </div>
                        `}
                    </div>

                    <div className="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-2">
                        <button onClick=${() => onEdit(assignment)} className="p-2 text-gray-500 hover:text-blue-500 transition-colors">
                            <${Icon} name="Edit2" className="w-4 h-4" />
                        </button>
                        <button onClick=${() => onDelete(assignment.id)} className="p-2 text-gray-500 hover:text-red-500 transition-colors">
                            <${Icon} name="Trash2" className="w-4 h-4" />
                        </button>
                    </div>
                </div>
            `;
        };

        // Component: Assignment Form
        const AssignmentForm = ({ initialData, onSave, onCancel }) => {
            const [title, setTitle] = useState(initialData?.title || '');
            const [subject, setSubject] = useState(initialData?.subject || '');
            const [dueDate, setDueDate] = useState(initialData?.dueDate ? initialData.dueDate.slice(0, 16) : '');
            const [notes, setNotes] = useState(initialData?.notes || '');
            const [reminders, setReminders] = useState(initialData?.reminders || ['at_due_date']);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title || !subject || !dueDate) return;
                onSave({ title, subject, dueDate: new Date(dueDate).toISOString(), notes, reminders });
            };

            const toggleReminder = (type) => {
                setReminders(prev => prev.includes(type) ? prev.filter(t => t !== type) : [...prev, type]);
            };

            return html`
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/50 backdrop-blur-sm transition-opacity">
                    <div className="w-full sm:max-w-md bg-white dark:bg-gray-800 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                        <div className="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">
                                ${initialData ? 'Edit Assignment' : 'New Assignment'}
                            </h2>
                            <button onClick=${onCancel} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <${Icon} name="X" className="w-6 h-6 text-gray-500" />
                            </button>
                        </div>
                        <form onSubmit=${handleSubmit} className="p-6 space-y-5 max-h-[80vh] overflow-y-auto">
                            <div className="space-y-1">
                                <label className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">
                                    <${Icon} name="Type" className="w-3 h-3" /> Name
                                </label>
                                <input required value=${title} onChange=${(e) => setTitle(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="e.g. Final Essay" />
                            </div>
                            <div className="space-y-1">
                                <label className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">
                                    <${Icon} name="Book" className="w-3 h-3" /> Subject
                                </label>
                                <input required value=${subject} onChange=${(e) => setSubject(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 dark:text-white" placeholder="e.g. Math 101" />
                            </div>
                            <div className="space-y-1">
                                <label className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">
                                    <${Icon} name="Calendar" className="w-3 h-3" /> Due Date
                                </label>
                                <input required type="datetime-local" value=${dueDate} onChange=${(e) => setDueDate(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 dark:text-white" />
                            </div>
                            <div className="space-y-1">
                                <label className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">
                                    <${Icon} name="Bell" className="w-3 h-3" /> Reminders
                                </label>
                                <div className="flex flex-wrap gap-2">
                                    ${REMINDER_OPTIONS.map(opt => html`
                                        <button key=${opt.value} type="button" onClick=${() => toggleReminder(opt.value)} 
                                            className="px-3 py-1.5 rounded-full text-xs font-medium transition-all ${reminders.includes(opt.value) ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300'}">
                                            ${opt.label}
                                        </button>
                                    `)}
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all">
                                ${initialData ? 'Update Task' : 'Add Task'}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        };

        // Main App Component
        const App = () => {
            const [assignments, setAssignments] = useState([]);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [editingAssignment, setEditingAssignment] = useState(null);
            const [filter, setFilter] = useState('active');

            // Initialization
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) setAssignments(JSON.parse(saved));
                
                const theme = localStorage.getItem('theme');
                const isDark = theme ? theme === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
                setIsDarkMode(isDark);
                if (isDark) document.documentElement.classList.add('dark');
            }, []);

            // Save Persistence
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(assignments));
            }, [assignments]);

            // Notifications Service
            const sendNotification = (title, body) => {
                if (Notification.permission === 'granted') {
                    new Notification(title, { body });
                }
            };

            // Notification Timer
            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    setAssignments(prev => {
                        let changed = false;
                        const next = prev.map(task => {
                            if (task.isCompleted) return task;
                            const dueDate = new Date(task.dueDate);
                            const last = task.lastNotified || {};
                            
                            // Check At Due Date
                            if (task.reminders.includes('at_due_date') && !last.at_due_date && now >= dueDate) {
                                sendNotification('Deadline Met!', `${task.title} is due now.`);
                                changed = true; return { ...task, lastNotified: { ...last, at_due_date: true } };
                            }
                            // Check 1 Hour Before
                            if (task.reminders.includes('1_hour_before') && !last.hour_before) {
                                if (now >= new Date(dueDate.getTime() - 3600000) && now < dueDate) {
                                    sendNotification('Reminder: 1 Hour Left', `${task.title} is due soon.`);
                                    changed = true; return { ...task, lastNotified: { ...last, hour_before: true } };
                                }
                            }
                            return task;
                        });
                        return changed ? next : prev;
                    });
                }, 30000);
                return () => clearInterval(interval);
            }, [assignments]);

            const toggleTheme = () => {
                const next = !isDarkMode;
                setIsDarkMode(next);
                document.documentElement.classList.toggle('dark', next);
                localStorage.setItem('theme', next ? 'dark' : 'light');
            };

            const handleSave = (data) => {
                if (editingAssignment) {
                    setAssignments(prev => prev.map(a => a.id === editingAssignment.id ? { ...a, ...data, lastNotified: {} } : a));
                } else {
                    setAssignments(prev => [{ ...data, id: Date.now().toString(), isCompleted: false, lastNotified: {} }, ...prev]);
                }
                setIsFormOpen(false);
                setEditingAssignment(null);
            };

            const stats = useMemo(() => {
                const active = assignments.filter(a => !a.isCompleted);
                return { total: assignments.length, active: active.length, done: assignments.length - active.length };
            }, [assignments]);

            const filtered = useMemo(() => {
                return assignments.filter(a => filter === 'all' ? true : (filter === 'active' ? !a.isCompleted : a.isCompleted))
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            }, [assignments, filter]);

            return html`
                <div className="min-h-screen pb-24">
                    <header className="sticky top-0 z-40 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-b dark:border-gray-700">
                        <div className="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg"><${Icon} name="CheckCircle2" /></div>
                                <h1 className="text-xl font-black tracking-tight">AssignMate</h1>
                            </div>
                            <button onClick=${toggleTheme} className="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                                <${Icon} name=${isDarkMode ? 'Sun' : 'Moon'} />
                            </button>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto px-4 py-6">
                        <div className="grid grid-cols-3 gap-3 mb-8 text-center">
                            <div className="p-4 bg-white dark:bg-gray-800 rounded-2xl border dark:border-gray-700 shadow-sm">
                                <p className="text-[10px] uppercase font-bold text-gray-400">Tasks</p>
                                <p className="text-2xl font-black">${stats.total}</p>
                            </div>
                            <div className="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-2xl border dark:border-blue-900/30 shadow-sm">
                                <p className="text-[10px] uppercase font-bold text-blue-500">Active</p>
                                <p className="text-2xl font-black text-blue-600">${stats.active}</p>
                            </div>
                            <div className="p-4 bg-green-50 dark:bg-green-900/10 rounded-2xl border dark:border-green-900/30 shadow-sm">
                                <p className="text-[10px] uppercase font-bold text-green-500">Done</p>
                                <p className="text-2xl font-black text-green-600">${stats.done}</p>
                            </div>
                        </div>

                        <div className="flex gap-2 mb-6">
                            ${['active', 'completed', 'all'].map(f => html`
                                <button key=${f} onClick=${() => setFilter(f)} className="flex-1 py-2 px-3 rounded-xl text-sm font-bold capitalize transition-all ${filter === f ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-gray-800 text-gray-500'}">
                                    ${f}
                                </button>
                            `)}
                        </div>

                        <div className="space-y-2">
                            ${filtered.length > 0 ? filtered.map(item => html`
                                <${AssignmentCard} 
                                    key=${item.id} 
                                    assignment=${item} 
                                    onToggleComplete=${(id) => setAssignments(prev => prev.map(a => a.id === id ? { ...a, isCompleted: !a.isCompleted } : a))} 
                                    onDelete=${(id) => confirm('Delete?') && setAssignments(prev => prev.filter(a => a.id !== id))}
                                    onEdit=${(a) => { setEditingAssignment(a); setIsFormOpen(true); }}
                                />
                            `) : html`
                                <div className="text-center py-20 opacity-50"><p>No assignments found</p></div>
                            `}
                        </div>
                    </main>

                    <button onClick=${() => { setEditingAssignment(null); setIsFormOpen(true); }} className="fixed bottom-8 right-8 w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-2xl transition-transform active:scale-95 z-40">
                        <${Icon} name="Plus" className="w-8 h-8" />
                    </button>

                    ${isFormOpen && html`<${AssignmentForm} initialData=${editingAssignment} onSave=${handleSave} onCancel=${() => setIsFormOpen(false)} />`}
                </div>
            `;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);

        // Request notifications on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
